<!DOCTYPE html>
<html lang="KO">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Info</title>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            display: flex;
            justify-content: flex-start; /* 왼쪽 정렬 설정 */
            align-items: stretch; /* 높이를 부모 요소의 높이에 맞추기 */
            width: 80%;
        }
        .input-container, .info-container {
            padding: 20px;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .input-container {
            order: 2;
        }
        .info-container {
            order: 1;
            width: calc(60% - 40px); /* 우측 박스의 너비 조정 */
            /* 좌측 박스의 너비는 40%로 설정되어 있으므로, 우측 박스는 전체 너비의 60%를 차지하도록 조정 */
        }
        .input-title {
            margin-bottom: 10px;
            font-size: 18px;
        }
        .number-display {
            margin-bottom: 20px;
            font-size: 24px;
            text-align: center; /* 숫자 표시 중앙 정렬 */
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3개의 컬럼을 균일하게 분할 */
            grid-gap: 10px;
            justify-items: center; /* 가로 방향 가운데 정렬 */
        }
        .button {
            width: 80px; /* 고정된 너비 */
            height: 80px; /* 고정된 높이 */
            background-color: #4CAF50;
            border: 2px solid transparent;
            color: white;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            outline: none;
        }

        .button:hover {
            background-color: #45a049;
        }
        .button:active {
            background-color: #3e8e41;
        }
        .button.clear {
            background-color: #f44336;
        }
        .button.ok {
            background-color: #2196F3;
        }
        .button:focus {
            border-bottom: 10px solid #4CAF50; /* 포커스가 되었을 때 테두리 아래 여백을 넓힘 */
        }
        .info-table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        .info-table th, .info-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-family: 'Noto Sans KR', sans-serif;
        }
        .info-table th {
            background-color: #f2f2f2;
            width: 100px;
        }
        .discount-container {
            margin-top: 20px;
        }
        .discount-button {
            background-color: #4CAF50;
            border: 2px solid transparent; /* 테두리를 투명으로 설정 */
            color: white;
            padding: 15px 20px; /* 버튼의 내부 여백을 조정하여 크기를 일정하게 맞춤 */
            text-align: center;
            text-decoration: none;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            outline: none;
            margin-right: 10px;
        }
        .discount-button:hover {
            background-color: #45a049;
        }
        .discount-button:active {
            background-color: #3e8e41;
        }
        .selected-discount {
            background-color: #ccc; /* 선택된 할인 내용 표시 버튼 색상 */
            border: 2px solid transparent; /* 테두리를 투명으로 설정 */
            color: #555; /* 텍스트 색상 */
            padding: 15px 20px; /* 버튼의 내부 여백을 조정하여 크기를 일정하게 맞춤 */
            text-align: center;
            font-size: 16px;
            border-radius: 4px;
            margin-top: 10px;
            display: none; /* 초기에는 보이지 않도록 설정 */
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
<div class="container">
    <div class="info-container">
        <h2 style="font-family: 'Noto Sans KR', sans-serif; margin-bottom: 20px;">차량 정보</h2>
        <table class="info-table">
            <tr>
                <th>차량번호</th>
                <td id="carNo">입력된 차량번호가 여기에 표시됩니다.</td>
            </tr>
            <tr>
                <th>입차시간</th>
                <td id="entTime">입차시간 정보</td>
            </tr>
            <tr>
                <th>주차시간</th>
                <td id="parkTime">주차시간 정보</td>
            </tr>
            <tr>
                <th>입구명</th>
                <td id="entName">입구명 정보</td>
            </tr>
        </table>
        <div class="discount-container" style="position: relative;">
            <h2>사용 가능 할인권</h2>
            <button class="discount-button" onclick="applyDiscount('1시간 무료')">1시간 무료</button>
            <button class="discount-button" onclick="applyDiscount('2시간 무료')">2시간 무료</button>
            <button class="discount-button" onclick="applyDiscount('완전 무료')">완전 무료</button>
            <button class="selected-discount" id="selectedDiscountBtn">선택된 할인권: </button>
            <button class="button ok" onclick="submitDiscount()" style="position: absolute; top: 115px; right: 0;">적용</button>

        </div>

    </div>

    <div class="input-container">
        <h2 class="input-title">차량번호 입력</h2>
        <div class="number-display" id="cnoDisplay">
            <span id="cno">----</span>
        </div>
        <div class="button-grid">
            <button class="button" onclick="addDigit(1)">1</button>
            <button class="button" onclick="addDigit(2)">2</button>
            <button class="button" onclick="addDigit(3)">3</button>
            <button class="button" onclick="addDigit(4)">4</button>
            <button class="button" onclick="addDigit(5)">5</button>
            <button class="button" onclick="addDigit(6)">6</button>
            <button class="button" onclick="addDigit(7)">7</button>
            <button class="button" onclick="addDigit(8)">8</button>
            <button class="button" onclick="addDigit(9)">9</button>
            <button class="button clear" onclick="clearDigit()">←</button>
            <button class="button" onclick="addDigit(0)">0</button>
            <button class="button ok" onclick="submitCarNo()">OK</button>
        </div>
    </div>
</div>

<!-- 중복된 차량을 선택하는 iframe -->
<iframe id="car-selection-frame" style="display: none;"></iframe>

<script>

    // 버튼을 누르면 입력이 되도록 하는 기능
    // 버튼을 누르면 입력이 되도록 하는 기능
    var carNo = '';

    function addDigit(digit) {
        if (carNo.length < 4) {
            carNo += digit;
            updateCarNoDisplay();
        }
    }
    function clearDigit() {
        carNo = carNo.slice(0, -1);
        updateCarNoDisplay();
    }

    function updateCarNoDisplay() {
        var carNoDisplay = document.getElementById("cno");
        carNoDisplay.innerText = carNo.padEnd(4, '-');
    }

    // 할인권을 선택하여 적용하는 함수
    function applyDiscount(discount) {
        var selectedDiscountBtn = document.getElementById("selectedDiscountBtn");
        selectedDiscountBtn.innerText = "선택된 할인권: " + discount;
        selectedDiscountBtn.style.display = "block";
    }

    // 차량 정보를 가져오는 함수
    function submitCarNo() {
        if (carNo.length === 4) {
            fetch(`/discount/${carNo}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('차량을 찾을 수 없습니다.'); // 오류 발생 시 catch 블록으로 이동
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data); // 서버로부터 받은 데이터를 콘솔에 출력
                    if (data.duplicate) {
                        // 중복된 차량번호가 있을 경우 선택할 수 있는 목록 표시
                        showCarSelectionFrame(data.cars);
                    } else {
                        // 중복된 차량번호가 없을 경우 차량 정보 표시
                        const carInfo = {
                            cno: data.cno,
                            ent_time: data.ent_time,
                            ptime: data.ptime,
                            ent: data.ent
                        };
                        displayCarInfo(carInfo);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error.message); // 오류 메시지 알림 표시
                });
        } else {
            alert("4자리의 차량번호를 입력하세요.");
        }
    }



    // 적용 버튼을 눌렀을 때 할인 정보를 서버에 제출하는 함수
    function submitDiscount() {
        var selectedDiscountBtn = document.getElementById("selectedDiscountBtn");
        var discount = selectedDiscountBtn.innerText.split(": ")[1]; // 선택된 할인권 텍스트에서 할인 정보 추출

        if (carNo !== '----') {
            // 서버에 할인 정보를 전송하여 차량의 할인권 정보 업데이트
            updateDiscountInfo(discount);
        } else {
            alert('차량번호를 입력해주세요.');
        }
    }

    // 서버에 할인 정보를 전송하여 차량의 할인권 정보 업데이트하는 함수
    function updateDiscountInfo(discount) {
        // 차량번호 가져오기
        var carNo = document.getElementById('carNo').textContent;

        // 요청 주소 설정
        var requestUrl = `/discount/${carNo}/discount?disc=${encodeURIComponent(discount)}`;

        // 할인 정보를 차량 정보에 반영
        fetch(requestUrl, {  // 수정된 요청 주소 사용
            method: 'PUT',  // 메서드를 PUT으로 변경
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message); // 서버에서 받은 응답 메시지를 알림창으로 표시
            })
            .catch(error => console.error('Error:', error));
    }


    // 중복된 차량 목록을 표시하는 함수
    function showCarSelectionFrame(cars) {
        const frame = document.getElementById('car-selection-frame');
        const html = `
        <h2>중복된 차량 번호가 있습니다.</h2>
        <ul>
            ${cars.map(car => `<li><a href="#" onclick="selectCar('${car.cno}')">${car.cno} ${car.ent}</a></li>`).join('')}
        </ul>
    `;
        frame.srcdoc = html;
        frame.style.display = 'block';
    }

    // 사용자가 차량을 선택할 때 실행되는 함수
    function selectCar(carNo) {
        fetch(`/discount/${carNo}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('차량을 찾을 수 없습니다.');
                }
                return response.json();
            })
            .then(data => {
                displayCarInfo(data); // 선택한 차량 정보 표시
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message);
            });
    }


    function displayCarInfo(carInfo) {
        if (carInfo) {
            // 차량 정보 표시를 위해 각 요소의 ID를 가져옵니다.
            const carNoElement = document.getElementById('carNo');
            const entTimeElement = document.getElementById('entTime');
            const parkTimeElement = document.getElementById('parkTime');
            const entNameElement = document.getElementById('entName');

            // 각 요소에 해당하는 데이터를 넣어줍니다.
            carNoElement.textContent = carInfo.cno || '정보 없음'; // cno 속성이 없는 경우 기본값으로 '정보 없음'을 표시합니다.
            entTimeElement.textContent = carInfo.ent_time || '정보 없음';
            parkTimeElement.textContent = carInfo.ptime || '정보 없음';
            entNameElement.textContent = carInfo.ent || '정보 없음';
        } else {
            console.error('Car info is empty or undefined.');
        }
    }


</script>
</body>
</html>